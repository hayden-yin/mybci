## 项目实施计划书：报告图形结构化与关键信息提取（KIE）系统（根据最新代码编写计划修订版）

### 一、项目概述与目标

1. 建立基于 **PaddleOCR PP-Structure** 的自动化预标注流程，通过 **Label Studio** 进行人工校正，形成可复用的结构化配置模板（`config_ocr_*.json`），实现“一次标注，多次复用”的日常报告自动化处理。
2. 项目名称：报告图形结构化与关键信息提取（KIE）系统。
3. 核心输出：结构化 CSV 或 Excel 文件，包含校正后的文本、坐标及 KIE 关系。

* 核心技术栈更新说明：
    - **OCR 引擎**：使用 PaddleOCR ≥ 2.7（含 PP-Structure），兼容 CUDA 12.9。
    - **Python 环境**：Conda 环境 `mybci`，Python 3.10。
    - **Web 后端**：FastAPI + Uvicorn（非 Flask/gunicorn）。
    - **ML Backend 服务**：基于 FastAPI 实现，与 Web App 共享核心 OCR 逻辑。
    - **配置管理**：所有配置文件统一存放于 `config/` 目录（如 `config_ocr_bci.json`）。
    - **输入/输出目录**：扁平化设计，`input/` 存放原始图片，`output/` 存放导出结果。

### 二、项目实施阶段与里程碑（共 4 个阶段，按代码计划修订）

1. P1：基础环境与模型验证
    * 交付物：统一 Conda 环境（`mybci`），支持 PaddlePaddle-GPU（CUDA 12.9）、PaddleOCR ≥ 2.7、Label Studio、FastAPI。
    * 耗时：1 周

2. P2：ML 后端核心开发
    * 交付物：FastAPI 实现的 ML Backend 服务（`src/mybci/ml_backend/server.py`），调用统一 OCR 执行器。
    * 耗时：1–2 周

3. P3：标注模板与工作流设计
    * 交付物：Label Studio XML 模板 + `convert_ls_to_config.py` 脚本，生成 `config/config_ocr_*.json`。
    * 耗时：1 周

4. P4：数据处理与交付
    * 交付物：`ocr_executor.py` + `csv_handler.py`，支持多配置、动态文件名、CSV/Excel 输出。
    * 耗时：1–2 周

### 三、详细任务分解（WBS，按最新代码结构修订）

1. 阶段一：基础环境搭建与模型验证 (P1)

    * 任务 1.1：GPU 环境配置（驱动 + CUDA 12.9 + cuDNN）
        - 验证命令：`nvcc -V` 显示 CUDA 12.9；`nvidia-smi` 显示驱动兼容 RTX 2080。
        - 检查结果
            -PaddlePaddle 3.2 + CUDA 支持 ✅
            -PaddleOCR + PPStructureV3 ✅
            -FastAPI / Uvicorn / WebSocket ✅
            -数据处理库（Pandas / openpyxl / lxml）✅
            -路径管理 & dotenv ✅
            -Pydantic Settings ✅
                **在 Pydantic 2.x 版本之后：BaseSettings 已经不再直接包含在 pydantic 包里。它被移到了 pydantic-settings 包中。如果你的代码里直接 from pydantic import BaseSettings 会报错。-正确的做法是安装 pydantic-settings，然后导入：from pydantic_settings import BaseSettings
                **PPStructure 已被替换为 PPStructureV3 → 导入时使用 from paddleocr import PPStructureV3

    * 任务 1.2：Conda 环境创建与依赖安装
        - 环境名：`mybci`
        - Python 版本：3.10
        - 安装命令：
            1. `conda create -n mybci python=3.10`
            2. `conda activate mybci`
            3. `pip install paddlepaddle-gpu`（自动匹配 CUDA 12.9）
            4. `pip install "paddleocr>=2.7" label-studio pandas openpyxl lxml fastapi uvicorn`

    * 任务 1.3：PP-Structure 初步验证
        - 输出：原始 OCR JSON，用于后续转换脚本开发。

    * 任务 1.4：字段清单确认
        - 输出：`Field_List.md`，用于指导 `config_ocr_*.json` 中 `output_columns` 定义。

2. 阶段二：Label Studio ML 后端开发（P2）

    * 任务 2.1：搭建 ML Backend 服务框架
        - 使用 FastAPI（非 Flask），入口为 `src/mybci/ml_backend/server.py`
        - 启动脚本：`run_ml_backend.py`

    * 任务 2.2：开发 PP-Structure 接口模块
        - 文件：`src/mybci/ocr_processing/ppstructure_engine.py`
        - 功能：封装表格检测、文本识别等原子操作。

    * 任务 2.3：坐标归一化逻辑
        - 函数：`normalize_box(x1, y1, x2, y2, img_w, img_h)` → [x, y, width, height]（0–100%）

    * 任务 2.4：PP-Structure → Label Studio JSON 转换
        - 文件：`src/mybci/ml_backend/ocr_adapter.py`
        - 关键变更：**不再直接调用 ppstructure_engine**，而是调用 `ocr_executor.process_image(config_name, image_path)` 获取统一结果，再转为 LS 格式。
        - 支持 Text（RectangleLabels + TextArea）和 Table（进阶）。

    * 任务 2.5：ML Backend 稳定性测试
        - 测试方式：通过 Label Studio Web UI 调用预标注，验证响应格式与内容正确性。

3. 阶段三：标注模板与工作流设计 (P3)

    * 任务 3.1–3.5：Label Studio XML 模板设计
        - 包含：图像、矩形框、文本域、关系标签（`<Relation>`）
        - 输出：XML 模板 + 《校正操作手册》

    * 任务 3.6：端到端集成测试
        - 流程：Label Studio 导出 JSON → 运行 `utils/convert_ls_to_config.py` → 生成 `config/config_ocr_bci.json`

4. 阶段四：数据处理与交付 (P4)

    * 任务 4.1：读取 LS 导出 JSON
        - 文件：`utils/json_handler.py`

    * 任务 4.2：关系重建与结构化
        - 核心逻辑统一于 `ocr_executor.py`：
            * 加载 `config/config_ocr_{config_name}.json`
            * 调用 `ppstructure_engine` 获取原始结果
            * 根据配置中的区域/关键词/正则提取字段
            * 返回 Python dict（非 LS JSON）

    * 任务 4.2.1–4.2.3：文本、KIE、表格提取
        - 所有逻辑由 `ocr_executor.py` 实现，确保 Web App 与 ML Backend 行为一致。

    * 任务 4.3–4.4：数据模型与清洗
        - 使用 Pandas DataFrame，列名由 `config_ocr.json` 中 `output_columns` 定义。

    * 任务 4.5：CSV/Excel 导出
        - 文件：`utils/csv_handler.py`
        - 支持动态文件名（如 `bci_report_2025-11-01.csv`）
        - 编码：UTF-8 with BOM（Excel 兼容）

    * 任务 4.6：端到端测试
        - 测试脚本：`run_web_app.py` 启动后，通过 Web UI 上传 → 处理 → 生成 → 下载

### 四、项目资源与角色分配（微调）

1. 项目经理
    * 职责：协调进度、验收 `config_ocr_*.json` 与最终 CSV。
    * 关键阶段：P1（字段确认）、P3（模板验收）、P4（交付测试）

2. 算法工程师
    * 职责：开发 `ppstructure_engine.py`、`ocr_executor.py`、`ocr_adapter.py`
    * 技能：PaddleOCR、PP-Structure、坐标处理、KIE 逻辑
    * 关键阶段：P1、P2、P4

3. 系统工程师
    * 职责：环境搭建、FastAPI 服务开发（Web + ML Backend）、Docker 部署
    * 技能：Conda/Docker、FastAPI、Uvicorn、pathlib 路径处理
    * 关键阶段：P1、P2、P5（Web 前端集成）

4. 业务/标注专家
    * 职责：定义字段、设计 XML 模板、编写校正规范
    * 关键阶段：P1、P3

### 五、系统运行架构与模板复用机制（全面更新）

1. 顺序执行机制（Stage Pipeline）

    * Step 1️⃣：**OCR 预标注（仅首次）**
        - 启动 Label Studio + ML Backend（`run_ml_backend.py`）
        - 人工校正后导出 JSON

    * Step 2️⃣：**配置生成**
        - 运行 `python -m mybci.utils.convert_ls_to_config --input ls_export.json --output config/config_ocr_bci.json`

    * Step 3️⃣：**日常自动化处理**
        - 启动 Web App：`python run_web_app.py`
        - 用户上传图片至 `input/`
        - 调用 `/process?config_name=bci` → 触发 `ocr_executor.process_image("bci", ...)` 
        - 调用 `/generate` → 生成 `output/bci_report_YYYY-MM-DD.csv`

2. 模板复用机制

    * 配置文件命名规范：`config/config_ocr_{project_type}.json`
    * Web 前端提供下拉菜单选择 `config_name`（如 "bci", "blood"）
    * 当报告格式变更时，重新进入 Step 1–2，生成新配置（如 `config_ocr_bci_v2.json`）

3. 每日报告自动化处理流程（更新）

    * 不再使用 `daily_pipeline.py`，而是通过 Web API 实现：
        1. `POST /upload` → 上传图片
        2. `POST /process?config_name=bci` → 批量 OCR
        3. `POST /generate?config_name=bci` → 生成 CSV
    * 支持 WebSocket 实时日志（`/ws`）

4. 架构优势（强化）

    * **逻辑统一**：`ocr_executor.py` 为唯一 OCR 核心，被 Web 和 ML Backend 共享，100% 一致性。
    * **去耦合设计**：配置、输入、输出目录扁平化，通过 `config_name` 参数路由。
    * **可安装包结构**：`pip install -e .` 后，所有模块可通过 `from mybci.xxx import ...` 导入。
    * **跨平台兼容**：使用 `pathlib`、UTF-8 编码、FastAPI，支持 Windows/Linux。
    * **GPU 资源隔离**：ML Backend（标注阶段）与 Web App（日常处理）可分时运行，避免冲突。
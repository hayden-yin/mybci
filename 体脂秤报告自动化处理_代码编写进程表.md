## 体脂秤报告自动化处理项目：代码编写与环境验证完整实施清单

### 环境验证与准备（阶段 P1）

1. 安装 GPU 驱动与 CUDA 12.9
    * 验证 GPU 与 CUDA 环境：
        - `nvidia-smi` → 显示 RTX 2080
        - `nvcc -V` → 显示 CUDA 12.9
    * 若版本不符：
        - 更新 NVIDIA 驱动 ≥ 550.xx
        - 安装 CUDA Toolkit 12.9

1. 创建 Conda 环境
    * 命令：
        - `conda create -n mybci python=3.10`
        - `conda activate mybci`

1. 安装依赖包
    * 基础依赖：
        - `pip install paddlepaddle-gpu`
        - `pip install "paddleocr>=2.7" label-studio pandas openpyxl lxml fastapi uvicorn python-multipart`
    * 可选依赖：
        - `pip install watchdog python-dotenv pydantic`

1. 验证 PaddleOCR 与 GPU 是否正常
    * 测试脚本：
        - 
          ```python
          from paddleocr import PaddleOCR
          ocr = PaddleOCR(use_angle_cls=True, use_gpu=True)
          result = ocr.ocr('test.jpg', cls=True)
          print(result)
          ```
    * 验证标准：
        - 输出包含识别的文字块内容则安装成功。

1. 初始化项目目录结构
    * 创建命令：
        - 
          ```bash
          mkdir -p mybci/{config,input,output,src/mybci/{ocr_processing,ml_backend,webapp,utils,core}}

===============================================执行日期 2025/11/2 20：46=======================================================
        --补安装 pin install rq(2025/11/3)
        --补安装 pip install asgiref(2025/11/3)
        --补安装 pip install flask asgiref(2025/11/3)
===============================================执行日期 2025/11/3==============================================================
          ```
    * 根目录文件：
        - `run_web_app.py`
        - `run_ml_backend.py`
        - `requirements.txt`
        - `pyproject.toml`

---

### ML 后端开发（阶段 P2）

1. 创建底层 OCR 引擎模块
    * 文件路径：`src/mybci/ocr_processing/ppstructure_engine.py`
    * 内容示例：
        - 
          ```python
          from paddleocr import PaddleOCR

          ocr_engine = PaddleOCR(use_angle_cls=True, lang='ch', use_gpu=True)

          def run_ppstructure(image_path):
              result = ocr_engine.ocr(image_path, cls=True)
              return result
          ```

1. 创建统一执行器模块
    * 文件路径：`src/mybci/ocr_processing/ocr_executor.py`
    * 主要功能：
        - 加载配置文件
        - 调用 PaddleOCR 识别
        - 输出字段提取结果
    * 示例代码：
        - 
          ```python
          import json
          from pathlib import Path
          from mybci.ocr_processing.ppstructure_engine import run_ppstructure

          def process_image(config_name: str, image_path: str):
              config_path = Path(f"config/config_ocr_{config_name}.json")
              config = json.loads(config_path.read_text(encoding='utf-8'))
              ocr_result = run_ppstructure(image_path)
              extracted = {}
              for field in config.get("output_columns", []):
                  extracted[field] = ""  # TODO: 字段提取逻辑
              return extracted
          ```

1. 实现 ML 适配器模块
    * 文件路径：`src/mybci/ml_backend/ocr_adapter.py`
    * 内容示例：
        - 
          ```python
          from mybci.ocr_processing.ocr_executor import process_image

          def predict(image_path, config_name='bci'):
              result = process_image(config_name, image_path)
              return {"results": result}
          ```

1. 实现 ML 后端 FastAPI 服务
    * 文件路径：`src/mybci/ml_backend/server.py`
    * 内容示例：
        - 
          ```python
          from fastapi import FastAPI, UploadFile, File
          from mybci.ml_backend.ocr_adapter import predict

          app = FastAPI()

          @app.post("/predict")
          async def predict_api(file: UploadFile = File(...)):
              image_path = f"input/{file.filename}"
              with open(image_path, "wb") as f:
                  f.write(await file.read())
              return predict(image_path)
          ```

1. 启动 ML 后端服务
    * 文件路径：`run_ml_backend.py`
    * 内容示例：
        - 
          ```python
          import uvicorn
          if __name__ == "__main__":
              uvicorn.run("mybci.ml_backend.server:app", host="0.0.0.0", port=9000, reload=True)
          ```
    * 启动命令：
        - `python run_ml_backend.py`
---

### 配置模板与工作流（阶段 P3）

1. 启动 Label Studio 并导出标注数据
    * 启动命令：
        - `docker run -p 8080:8080 heartexlabs/label-studio`
    * 标注后导出：
        - 输出文件路径：`export/label_studio_export.json`

1. 创建配置转换脚本
    * 文件路径：`src/mybci/utils/convert_ls_to_config.py`
    * 示例代码：
        - 
          ```python
          import json, sys
          from pathlib import Path

          def convert(input_path, output_path):
              data = json.loads(Path(input_path).read_text(encoding='utf-8'))
              config = {"output_columns": [f["value"] for f in data.get("labels", [])]}
              Path(output_path).write_text(json.dumps(config, indent=2, ensure_ascii=False), encoding='utf-8')

          if __name__ == "__main__":
              convert(sys.argv[1], sys.argv[2])
          ```

1. 生成配置文件
    * 运行命令：
        - 
          ```bash
          python -m mybci.utils.convert_ls_to_config export/label_studio_export.json config/config_ocr_bci.json
          ```

---

### 数据处理与输出开发（阶段 P4）

1. 实现 CSV 导出模块
    * 文件路径：`src/mybci/utils/csv_handler.py`
    * 示例代码：
        - 
          ```python
          import pandas as pd
          from datetime import datetime
          from pathlib import Path

          def export_to_csv(data_list, config_name):
              df = pd.DataFrame(data_list)
              filename = f"output/{config_name}_report_{datetime.now():%Y-%m-%d}.csv"
              df.to_csv(filename, index=False, encoding='utf-8-sig')
              return filename
          ```

1. 开发 Web 应用后端
    * 文件路径：`src/mybci/webapp/app.py`
    * 示例代码：
        - 
          ```python
          from fastapi import FastAPI, UploadFile, File
          from mybci.ocr_processing.ocr_executor import process_image
          from mybci.utils.csv_handler import export_to_csv
          from pathlib import Path

          app = FastAPI()

          @app.post("/upload")
          async def upload(file: UploadFile = File(...)):
              path = f"input/{file.filename}"
              with open(path, "wb") as f:
                  f.write(await file.read())
              return {"status": "uploaded", "path": path}

          @app.post("/process")
          async def process(config_name: str = "bci"):
              data = []
              for img in Path("input").glob("*.jpg"):
                  data.append(process_image(config_name, str(img)))
              csv_path = export_to_csv(data, config_name)
              return {"status": "done", "output": csv_path}
          ```

1. 启动 Web 应用
    * 文件路径：`run_web_app.py`
    * 内容示例：
        - 
          ```python
          import uvicorn
          if __name__ == "__main__":
              uvicorn.run("mybci.webapp.app:app", host="0.0.0.0", port=8000, reload=True)
          ```
    * 启动命令：
        - `python run_web_app.py`

---

### 端到端测试与交付（阶段 P5）

1. 启动所有服务
    * ML 后端：
        - `python run_ml_backend.py`
    * Web 前端：
        - `python run_web_app.py`

1. 访问接口
    * 打开浏览器访问：
        - `http://localhost:8000`
    * 操作流程：
        - 上传图片至 `input/`
        - 点击“开始处理”
        - 下载生成的 CSV 文件

1. 验证结果
    * 输入文件夹：
        - `input/`
    * 输出文件夹：
        - `output/bci_report_YYYY-MM-DD.csv`

---

### 部署与维护（阶段 P6）

1. 容器化部署
    * Dockerfile 示例：
        - 
          ```dockerfile
          FROM python:3.10
          WORKDIR /app
          COPY . .
          RUN pip install -r requirements.txt
          CMD ["python", "run_web_app.py"]
          ```

1. 系统服务部署
    * Linux：
        - 使用 systemd 创建 `mybci.service`
    * Windows：
        - 使用 NSSM 注册自启动服务

1. 健康检查接口
    * 新增 `/health` 路由：
        - 返回版本号、时间戳与运行状态

1. 日志与监控
    * 推荐使用：
        - 结构化日志输出（JSON 格式）
        - Prometheus / Grafana 监控

---

### 一键初始化与调试建议

1. 可选自动化脚本（`setup_project.py`）
    * 功能：
        - 自动创建目录与文件
        - 生成模板代码骨架
        - 验证依赖是否可用
    * 启动命令：
        - `python setup_project.py`

1. 调试与测试建议
    * 调试模式：
        - `uvicorn.run(..., reload=True, log_level="debug")`
    * 测试接口：
        - Postman / curl / Label Studio ML Backend 测试面板
    * 验证点：
        - GPU 调用
        - OCR 输出
        - CSV 生成
        - Web API 响应

---
